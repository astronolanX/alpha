---
import Layout from '../layouts/Layout.astro';
import GridOverlay from '../components/GridOverlay.astro';
import StoryboardLayer from '../components/StoryboardLayer.astro';
import Header from '../components/Header.astro';
import Terminal from '../components/Terminal.astro';
import StatusBar from '../components/StatusBar.astro';
import Modal from '../components/Modal.astro';
---

<Layout>
  <!-- Grid Overlay (toggleable) -->
  <GridOverlay />

  <!-- Storyboard Annotations -->
  <StoryboardLayer />

  <!-- Main Content Layer -->
  <div class="canvas">
    <Header />
    <Terminal />
    <StatusBar />
  </div>

  <!-- Modal Overlay -->
  <Modal />

  <!-- Client-side Terminal Script -->
  <script>
    /**
     * Nolan's Terminal Portfolio
     * Interactive terminal with storyboard grid overlay
     */

    const CONFIG = {
      linkedinUrl: 'https://www.linkedin.com/in/astronolan/',
      typingDelay: { min: 300, max: 600 },
    };

    const PORTFOLIO_DATA = {
      about: {
        name: 'Nolan Figueroa',
        title: 'Design Engineer',
        bio: `I'm a Design Engineer focused on creating intuitive and performant experiences across web, mobile, and smart home platforms. I bridge the gap between design and development, bringing ideas to life with clean code and thoughtful interfaces.`,
        location: 'Based in the US',
        interests: ['Design Systems', 'Frontend Architecture', 'Home Automation', 'Developer Tools'],
      },

      projects: [
        {
          name: 'Design System Framework',
          description: 'A comprehensive component library with accessibility-first design principles and theming support.',
          tags: ['React', 'TypeScript', 'Storybook', 'A11y'],
        },
        {
          name: 'Smart Home Dashboard',
          description: 'Real-time monitoring and control interface for IoT devices with adaptive layouts.',
          tags: ['Vue.js', 'WebSocket', 'D3.js', 'Home Assistant'],
        },
        {
          name: 'Mobile Banking Experience',
          description: 'Native iOS app redesign focusing on simplifying complex financial workflows.',
          tags: ['Swift', 'UIKit', 'FinTech', 'UX'],
        },
        {
          name: 'Terminal Portfolio',
          description: "This interactive terminal you're using now! Built with Astro and Catppuccin theming.",
          tags: ['Astro', 'Tailwind', 'TypeScript', 'Catppuccin'],
        },
      ],

      resume: {
        experience: [
          {
            title: 'Design Engineer',
            company: 'Current Role',
            date: 'Present',
            highlights: [
              'Building design systems and component libraries',
              'Collaborating with product and design teams',
              'Optimizing web performance and accessibility',
            ],
          },
          {
            title: 'Frontend Developer',
            company: 'Previous Company',
            date: '2020 - 2023',
            highlights: [
              'Developed responsive web applications',
              'Implemented CI/CD pipelines',
              'Mentored junior developers',
            ],
          },
        ],
        skills: [
          'JavaScript/TypeScript', 'React', 'Vue.js', 'Swift',
          'Node.js', 'CSS/Tailwind', 'Figma', 'Git',
        ],
      },
    };

    class TerminalApp {
      history: HTMLElement | null;
      input: HTMLInputElement | null;
      submitBtn: HTMLElement | null;
      themeToggle: HTMLElement | null;
      gridToggle: HTMLElement | null;
      modalOverlay: HTMLElement | null;
      modalTitle: HTMLElement | null;
      modalContent: HTMLElement | null;
      modalClose: HTMLElement | null;
      cmdPills: NodeListOf<HTMLElement>;
      statusTime: HTMLElement | null;
      statusTheme: HTMLElement | null;
      statusGrid: HTMLElement | null;

      constructor() {
        this.history = document.getElementById('terminalHistory');
        this.input = document.getElementById('terminalInput') as HTMLInputElement;
        this.submitBtn = document.getElementById('submitBtn');
        this.themeToggle = document.querySelector('.theme-toggle');
        this.gridToggle = document.querySelector('.grid-toggle');
        this.modalOverlay = document.getElementById('modalOverlay');
        this.modalTitle = document.getElementById('modalTitle');
        this.modalContent = document.getElementById('modalContent');
        this.modalClose = document.getElementById('modalClose');
        this.cmdPills = document.querySelectorAll('.cmd-pill');
        this.statusTime = document.getElementById('statusTime');
        this.statusTheme = document.getElementById('statusTheme');
        this.statusGrid = document.getElementById('statusGrid');

        this.init();
      }

      init() {
        this.loadTheme();
        this.loadGrid();

        this.themeToggle?.addEventListener('click', () => this.toggleTheme());
        this.gridToggle?.addEventListener('click', () => this.toggleGrid());

        this.input?.addEventListener('keydown', (e: KeyboardEvent) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.handleSubmit();
          }
        });
        this.submitBtn?.addEventListener('click', () => this.handleSubmit());

        this.cmdPills.forEach(pill => {
          pill.addEventListener('click', () => this.handleCommand(pill));
        });

        this.modalClose?.addEventListener('click', () => this.closeModal());
        this.modalOverlay?.addEventListener('click', (e) => {
          if (e.target === this.modalOverlay) this.closeModal();
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.modalOverlay?.classList.contains('active')) {
            this.closeModal();
          }
        });

        this.updateStatusTime();
        setInterval(() => this.updateStatusTime(), 1000);

        this.input?.focus();
      }

      loadTheme() {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'macchiato' : 'latte');
        document.documentElement.setAttribute('data-theme', theme);
        this.updateStatusTheme(theme);
      }

      toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'macchiato' ? 'latte' : 'macchiato';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        this.updateStatusTheme(next);
      }

      updateStatusTheme(theme: string) {
        if (this.statusTheme) {
          this.statusTheme.textContent = theme;
        }
      }

      loadGrid() {
        const saved = localStorage.getItem('grid');
        const grid = saved || 'off';
        document.documentElement.setAttribute('data-grid', grid);
        this.updateStatusGrid(grid);
      }

      toggleGrid() {
        const current = document.documentElement.getAttribute('data-grid');
        const next = current === 'on' ? 'off' : 'on';
        document.documentElement.setAttribute('data-grid', next);
        localStorage.setItem('grid', next);
        this.updateStatusGrid(next);
      }

      updateStatusGrid(state: string) {
        if (this.statusGrid) {
          this.statusGrid.textContent = `grid: ${state}`;
        }
      }

      updateStatusTime() {
        if (this.statusTime) {
          const now = new Date();
          this.statusTime.textContent = now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          });
        }
      }

      getTimestamp() {
        const now = new Date();
        return now.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });
      }

      createBlock() {
        const block = document.createElement('div');
        block.className = 'terminal-block';
        return block;
      }

      renderCommand(cmdText: string, parts: Array<{type: string, text: string}> | null = null) {
        const time = this.getTimestamp();

        let commandHtml = '';
        if (parts) {
          commandHtml = parts.map(p => {
            if (p.type === 'keyword') return `<span class="cmd-keyword">${p.text}</span>`;
            if (p.type === 'argument') return `<span class="cmd-argument">${p.text}</span>`;
            if (p.type === 'flag') return `<span class="cmd-flag">${p.text}</span>`;
            if (p.type === 'string') return `<span class="cmd-string">${p.text}</span>`;
            if (p.type === 'operator') return `<span class="cmd-operator">${p.text}</span>`;
            return p.text;
          }).join(' ');
        } else {
          commandHtml = `<span class="cmd-keyword">${cmdText}</span>`;
        }

        return `
          <div class="block-command">
            <span class="cmd-timestamp">${time}</span>
            ${commandHtml}
          </div>
        `;
      }

      renderOutput(content: string) {
        return `<div class="block-output">${content}</div>`;
      }

      renderError(message: string) {
        return `<div class="output-error">Error: ${message}</div>`;
      }

      addBlock(commandHtml: string, outputHtml: string) {
        const block = this.createBlock();
        block.innerHTML = commandHtml + outputHtml;
        this.history?.appendChild(block);
        this.scrollToBottom();
      }

      addTypingIndicator() {
        const block = this.createBlock();
        block.className = 'terminal-block typing-block';
        block.innerHTML = `
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        `;
        this.history?.appendChild(block);
        this.scrollToBottom();
        return block;
      }

      removeTypingIndicator(el: HTMLElement | null) {
        if (el && el.parentNode) {
          el.parentNode.removeChild(el);
        }
      }

      scrollToBottom() {
        if (this.history) {
          this.history.scrollTop = this.history.scrollHeight;
        }
      }

      handleSubmit() {
        const value = this.input?.value.trim();
        if (!value) return;

        if (this.input) this.input.value = '';
        this.processInput(value);
      }

      handleCommand(pill: HTMLElement) {
        const cmd = pill.dataset.cmd;
        const action = pill.dataset.action;

        if (action === 'linkedin') {
          const commandHtml = this.renderCommand('open', [
            { type: 'keyword', text: 'open' },
            { type: 'string', text: 'linkedin' }
          ]);
          const outputHtml = this.renderOutput(`<p class="output-text output-success">Opening LinkedIn profile...</p>`);
          this.addBlock(commandHtml, outputHtml);

          setTimeout(() => {
            window.open(CONFIG.linkedinUrl, '_blank', 'noopener,noreferrer');
          }, 300);
          return;
        }

        if (cmd) {
          this.processInput(cmd);
        }
      }

      async processInput(input: string) {
        const cmd = input.toLowerCase().trim();
        const parts = this.parseCommand(cmd);
        const commandHtml = this.renderCommand(cmd, parts);

        const typing = this.addTypingIndicator();

        await this.delay(CONFIG.typingDelay.min + Math.random() * (CONFIG.typingDelay.max - CONFIG.typingDelay.min));

        this.removeTypingIndicator(typing);

        const outputHtml = this.getResponse(cmd);
        this.addBlock(commandHtml, outputHtml);
      }

      parseCommand(cmd: string) {
        const words = cmd.split(/\s+/);
        const parts: Array<{type: string, text: string}> = [];

        words.forEach((word, i) => {
          if (i === 0) {
            parts.push({ type: 'keyword', text: word });
          } else if (word.startsWith('-')) {
            parts.push({ type: 'flag', text: word });
          } else if (word.startsWith('"') || word.startsWith("'")) {
            parts.push({ type: 'string', text: word });
          } else {
            parts.push({ type: 'argument', text: word });
          }
        });

        return parts;
      }

      getResponse(cmd: string) {
        if (cmd === 'clear' || cmd === 'cls') {
          this.clearHistory();
          return this.renderOutput(`<p class="output-text output-success">Terminal cleared.</p>`);
        }

        if (cmd === 'help' || cmd === '--help' || cmd === '-h') {
          return this.renderOutput(`
            <p class="output-text text-green">Available commands:</p>
            <p class="output-text"><span class="text-mauve">projects</span>  - View my portfolio of work</p>
            <p class="output-text"><span class="text-mauve">about</span>     - Learn more about me</p>
            <p class="output-text"><span class="text-mauve">resume</span>    - See my experience and skills</p>
            <p class="output-text"><span class="text-mauve">contact</span>   - Get in touch</p>
            <p class="output-text"><span class="text-mauve">clear</span>     - Clear the terminal</p>
            <p class="output-text"><span class="text-mauve">grid</span>      - Toggle the grid overlay</p>
            <p class="output-text"><span class="text-mauve">theme</span>     - Toggle light/dark theme</p>
            <p class="output-text text-subtext" style="margin-top: 8px;">Or just type a question!</p>
          `);
        }

        if (cmd === 'grid') {
          this.toggleGrid();
          const state = document.documentElement.getAttribute('data-grid');
          return this.renderOutput(`<p class="output-text output-success">Grid overlay ${state === 'on' ? 'enabled' : 'disabled'}.</p>`);
        }

        if (cmd === 'theme') {
          this.toggleTheme();
          const theme = document.documentElement.getAttribute('data-theme');
          return this.renderOutput(`<p class="output-text output-success">Switched to ${theme} theme.</p>`);
        }

        if (cmd === 'about' || cmd.includes('about') || cmd.includes('who')) {
          return this.renderOutput(`
            <p class="output-text text-green">${PORTFOLIO_DATA.about.name}</p>
            <p class="output-text text-subtext">${PORTFOLIO_DATA.about.title}</p>
            <p class="output-text" style="margin-top: 8px;">${PORTFOLIO_DATA.about.bio}</p>
            <p class="output-text" style="margin-top: 8px;"><span class="text-mauve">Location:</span> ${PORTFOLIO_DATA.about.location}</p>
            <p class="output-text"><span class="text-mauve">Focus:</span> ${PORTFOLIO_DATA.about.interests.join(', ')}</p>
            <div style="margin-top: 12px;">
              <a href="${CONFIG.linkedinUrl}" target="_blank" rel="noopener noreferrer" class="output-link output-link--primary">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                Connect on LinkedIn
              </a>
            </div>
          `);
        }

        if (cmd === 'projects' || cmd.includes('project') || cmd.includes('work') || cmd.includes('portfolio')) {
          let projectsList = PORTFOLIO_DATA.projects.map((p, i) => `
            <p class="output-text"><span class="text-mauve">${i + 1}.</span> <span class="text-green">${p.name}</span></p>
            <p class="output-text text-subtext" style="padding-left: 18px;">${p.description}</p>
            <p class="output-text text-overlay" style="padding-left: 18px; margin-bottom: 8px;">[${p.tags.join(', ')}]</p>
          `).join('');

          return this.renderOutput(`
            <p class="output-text text-green" style="margin-bottom: 8px;">Projects</p>
            ${projectsList}
            <div style="margin-top: 8px;">
              <button class="output-link" onclick="window.terminalApp.openModal('projects')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                View All Projects
              </button>
            </div>
          `);
        }

        if (cmd === 'resume' || cmd === 'cv' || cmd.includes('experience') || cmd.includes('skill')) {
          const exp = PORTFOLIO_DATA.resume.experience[0];
          return this.renderOutput(`
            <p class="output-text text-green" style="margin-bottom: 8px;">Resume</p>
            <p class="output-text"><span class="text-mauve">Current:</span> ${exp.title} at ${exp.company}</p>
            <p class="output-text" style="margin-top: 8px;"><span class="text-mauve">Skills:</span></p>
            <p class="output-text text-subtext">${PORTFOLIO_DATA.resume.skills.join(' | ')}</p>
            <div style="margin-top: 12px;">
              <button class="output-link output-link--primary" onclick="window.terminalApp.openModal('resume')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                View Full Resume
              </button>
            </div>
          `);
        }

        if (cmd === 'contact' || cmd.includes('contact') || cmd.includes('hire') || cmd.includes('reach')) {
          return this.renderOutput(`
            <p class="output-text text-green">Get in Touch</p>
            <p class="output-text" style="margin-top: 4px;">The best way to reach me is through LinkedIn.</p>
            <div style="margin-top: 12px;">
              <a href="${CONFIG.linkedinUrl}" target="_blank" rel="noopener noreferrer" class="output-link output-link--primary">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                Connect on LinkedIn
              </a>
            </div>
          `);
        }

        return this.renderError(`command not found: ${cmd}`);
      }

      clearHistory() {
        const welcome = this.history?.querySelector('.welcome-block');
        if (this.history) {
          this.history.innerHTML = '';
          if (welcome) {
            this.history.appendChild(welcome.cloneNode(true));
          }
        }
      }

      openModal(type: string) {
        let title = '';
        let content = '';
        let index = '01';

        switch (type) {
          case 'projects':
            title = 'projects';
            index = '01';
            content = this.renderProjectsModal();
            break;
          case 'resume':
            title = 'resume';
            index = '02';
            content = this.renderResumeModal();
            break;
          default:
            return;
        }

        if (this.modalTitle) this.modalTitle.textContent = title;
        const modalIndex = document.querySelector('.modal-index');
        if (modalIndex) modalIndex.textContent = index;
        if (this.modalContent) this.modalContent.innerHTML = content;
        this.modalOverlay?.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      closeModal() {
        this.modalOverlay?.classList.remove('active');
        document.body.style.overflow = '';
        this.input?.focus();
      }

      renderProjectsModal() {
        let html = '<div class="modal-section"><h2>Projects</h2><div class="project-grid">';

        PORTFOLIO_DATA.projects.forEach(project => {
          html += `
            <div class="project-card">
              <h4>${project.name}</h4>
              <p>${project.description}</p>
              <div class="project-tags">
                ${project.tags.map(tag => `<span class="project-tag">${tag}</span>`).join('')}
              </div>
            </div>
          `;
        });

        html += '</div></div>';
        return html;
      }

      renderResumeModal() {
        let html = `
          <div class="resume-header">
            <h1>${PORTFOLIO_DATA.about.name}</h1>
            <p>${PORTFOLIO_DATA.about.title}</p>
          </div>

          <div class="resume-section">
            <h2>Experience</h2>
        `;

        PORTFOLIO_DATA.resume.experience.forEach(exp => {
          html += `
            <div class="resume-item">
              <h3>${exp.title}</h3>
              <p class="company">${exp.company}</p>
              <p class="date">${exp.date}</p>
              <ul>
                ${exp.highlights.map(h => `<li>${h}</li>`).join('')}
              </ul>
            </div>
          `;
        });

        html += `
          </div>

          <div class="resume-section">
            <h2>Skills</h2>
            <div class="project-tags">
              ${PORTFOLIO_DATA.resume.skills.map(skill => `<span class="project-tag">${skill}</span>`).join('')}
            </div>
          </div>
        `;

        return html;
      }

      delay(ms: number) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
    }

    // Make terminalApp global for onclick handlers
    declare global {
      interface Window {
        terminalApp: TerminalApp;
      }
    }

    window.terminalApp = new TerminalApp();
  </script>
</Layout>
